#include <stdio.h>
#include <windef.h>
#include <windows.h>
#include <wincrypt.h>
#include <errhandlingapi.h>

BYTE TEXT[32] = {0xee, 0xf2, 0x77, 0xc3, 0xe1, 0xa0, 0xb7, 0xe4, 
                0xd5, 0x9d, 0x03, 0xe2, 0x88, 0x89, 0x1d, 0xad, 
                0x00, 0xaa, 0xb7, 0x71, 0xcf, 0xb9, 0xef, 0x45, 
                0xdd, 0xf4, 0xbd, 0x3c, 0x0e, 0xe4, 0xe1, 0xb5};

// BYTE HASH[32] = {0x84, 0x17, 0x3c, 0x22, 0x8c, 0xda, 0x31, 0xbf,
//                 0xcc, 0x71, 0xb0, 0x2b, 0x8d, 0xa9, 0x15, 0xae,
//                 0xfa, 0xa1, 0x8f, 0xe4, 0x9f, 0x21, 0x43, 0x2b,
//                 0x37, 0xab, 0x72, 0xac, 0x28, 0x72, 0x61, 0x37};

BYTE CI[36] = {65, 109, 33, 49, 66, 111, 98, 50,
                68, 67, 99, 52, 64, 35, 113, 51};

int main(){
    BYTE pbData[44];
    HCRYPTPROV phProv;
    HCRYPTPROV phKey;
    BOOL final = 0;
    DWORD pdwlen = 0x10U;
    HCRYPTHASH phHash;
    DWORD v2;
    BYTE v4[64];
    DWORD pdwDataLen;
    // for(int i = 16; i < 36; i ++) CI[i] = 0;

    pbData[0] = 8; pbData[1] = 2;
    pbData[2] = 0; pbData[3] = 0;
    *(int *)(pbData+4) = 26126;
    *(int *)(pbData+8) = 0x10;
    // pbData[4] = 0x0e; pbData[5] = 0x66; pbData[6] = 0; pbData[7] = 0;
    // pbData[8] = 0x10; pbData[9] = 0; pbData[10] = 0; pbData[11] = 0;
    for(int i = 0; i < 32; i ++){
        pbData[12+i] = 0;
    }

    int OK1 = CryptAcquireContextA(&phProv, 0, "Microsoft Enhanced RSA and AES Cryptographic Provider", 0x18u, 0);
    // CryptAcquireContextA(&phProv, 0, "Microsoft Enhanced RSA and AES Cryptographic Provider", 0x18u, 8u);
    CryptCreateHash(phProv, 0x800Cu, 0, 0, &phHash);
    v2 = strlen((const char *)CI);
    pdwDataLen = 32;
    int OK = CryptHashData(phHash, CI, v2, 0);
    CryptGetHashParam(phHash, 2u, v4, &pdwDataLen, 0);
    memcpy(pbData+12, v4, 0x10);


    CryptImportKey(phProv, pbData, 0x2Cu, 0, 0, &phKey);
    CryptSetKeyParam(phKey, 1u, pbData, 0);

    // int OK = CryptEncrypt(phKey, 0, final, 0, TEXT, &pdwlen, 0x20U);
    CryptDecrypt(phKey, 0, final, 0, TEXT, &pdwlen);
    final = 1;
    CryptDecrypt(phKey, 0, final, 0, TEXT+16, &pdwlen);

    for(int i = 0; i < 32; i ++){
        printf("%02x ", TEXT[i]);
    }
    // printf("%x %x", phProv, phKey);
    return 0;
}